<!-- explorer/templates/explorer/details.html -->

{% extends "explorer/base.html" %}
{% load static %}
{% block content %}
{% load custom_filters %}

<script src="{% static 'explorer/details.js' %}"></script>

<section class="vf-content | vf-stack vf-stack--600">
    <h2> MGnifam: {{ family_id }} </h2>
    <h3> Family size: {{ family_size }} </h3>
    <h3> Protein representative: <a href="http://proteins.mgnify.org/{{ protein_rep }}" target="_blank">{{ protein_rep }}</a></h3>
    <h4> Mask: {{ mask }} </h4>

    <article class="vf-card vf-card--brand vf-card--bordered">
        <div class="vf-grid vf-grid__col-4 | vf-card__content">
            <div class="vf-grid__col--span-1">
                <h3>ESM Atlas 3D structure</h3>
                <p>
                    Predicted 3D protein structure through the Meta AI ESMFold model.
                    ESMFold uses the representations from a large language model (ESM2)
                    to generate an accurate structure prediction from the sequence of a protein.
                </p>
                <p>
                    For more information visit:
                    <ul class="vf-list">
                        <li class="vf-list__item">
                            <a href="https://esmatlas.com/" target="_blank" class="vf-link ext">ESM Metagenomic Atlas</a>
                        </li>
                        <li class="vf-list__item">
                            <a href="https://www.science.org/doi/full/10.1126/science.ade2574"
                               target="_blank"
                               class="vf-link ext">
                                Evolutionary-scale prediction of atomic-level protein structure with a language model
                            </a>
                        </li>
                    </ul>
                </p>
            </div>
            <div class="vf-grid__col--span-3">
                <div id="pdb_viewer">
                    <pdbe-molstar
                        custom-data-url="{% static "cif/"|add:cif_path %}"
                        custom-data-format="cif"
                        alphafold-view="true"
                        bg-color-r="255"
                        bg-color-g="255"
                        bg-color-b="255"
                        sequence-panel="true"
                        landscape="true"
                    >
                    </pdbe-molstar>
                </div>
            </div>
        </div>
    </article>

    <article class="vf-card vf-card--brand vf-card--bordered">
        <div class="vf-card__content | vf-stack vf-stack--400">
            <h3 class="vf-card__heading">Multiple Sequence Alignment (Seed)</h3>
            <div id="msa-div"></div>
        </div>
    </article>

    <article class="vf-card vf-card--brand vf-card--bordered">
        <div class="vf-card__content | vf-stack vf-stack--400">
            <h3 class="vf-card__heading">Pfam model hits</h3>
            <table id="pfams-table"
                       class="vf-table .vf-u-margin__bottom--400">
                <thead class="vf-table__header">
                    <tr class="vf-table__row">
                        <th class="vf-table__heading" scope="col">No</th>
                        <th class="vf-table__heading" scope="col">Pfam hit</th>
                        <th class="vf-table__heading" scope="col">E-value</th>
                        <th class="vf-table__heading" scope="col">Query HMM</th>
                        <th class="vf-table__heading" scope="col">Template HMM</th>
                    </tr>
                </thead>
                <tbody class="vf-table__body">
                    {% for hit in hits_data %}
                        <tr class="vf-table__row pfam-item" data-proteinpfam="{{ hit.pfam_id }}">
                            <td class="vf-table__cell">{{ hit.rank }}</td>
                            <td class="vf-table__cell">
                                <a href="https://www.ebi.ac.uk/interpro/entry/pfam/{{ hit.pfam_id }}"
                                   target="_blank">{{ hit.name }}</a>
                            </td>
                            <td class="vf-table__cell">{{ hit.e_value }}</td>
                            <td class="vf-table__cell">{{ hit.query_hmm }}</td>
                            <td class="vf-table__cell">{{ hit.template_hmm }}</td>                            
                        </tr>
                    {% empty %}
                        <tr class="vf-table__heading">
                            <td class="vf-table__cell" colspan="5">No Pfam hits found</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </article>

    <article class="vf-card vf-card--brand vf-card--bordered">
        <div class="vf-card__content | vf-stack vf-stack--400">
            <h3 class="vf-card__heading">Structural Annotations</h3>
            <table id="structural-annotations-table" class="vf-table .vf-u-margin__bottom--400">
                <thead class="vf-table__header">
                    <tr class="vf-table__row">
                        <th class="vf-table__heading" scope="col">Target Structure</th>
                        <th class="vf-table__heading" scope="col">Aligned Length</th>
                        <th class="vf-table__heading" scope="col">Query Start</th>
                        <th class="vf-table__heading" scope="col">Query End</th>
                        <th class="vf-table__heading" scope="col">Target Start</th>
                        <th class="vf-table__heading" scope="col">Target End</th>
                        <th class="vf-table__heading" scope="col">E-value</th>
                    </tr>
                </thead>
                <tbody class="vf-table__body">
                    {% for annotation in structural_annotations %}
                        <tr class="vf-table__row">
                            <td class="vf-table__cell">{{ annotation.target_structure_identifier }}</td>
                            <td class="vf-table__cell">{{ annotation.aligned_length }}</td>
                            <td class="vf-table__cell">{{ annotation.query_start }}</td>
                            <td class="vf-table__cell">{{ annotation.query_end }}</td>
                            <td class="vf-table__cell">{{ annotation.target_start }}</td>
                            <td class="vf-table__cell">{{ annotation.target_end }}</td>
                            <td class="vf-table__cell">{{ annotation.e_value|floatformat:"-g" }}</td>
                        </tr>
                    {% empty %}
                        <tr class="vf-table__row">
                            <td class="vf-table__cell" colspan="7">No structural annotations found</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </article>
</section>

{% comment %} PDB viewer {% endcomment %}
<script src="https://cdn.jsdelivr.net/npm/babel-polyfill/dist/polyfill.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs/webcomponents-lite.js" charset="utf-8"></script>
<script src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs/custom-elements-es5-adapter.js" charset="utf-8"></script>
<script type="text/javascript" src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/pdbe-molstar-component-3.1.0.js"></script>

{% comment %} MSA Viewer {% endcomment %}
<link rel="stylesheet" href="{% static "explorer/msa.min.css" %}">
<script src="{% static "explorer/msa.min.js" %}"></script>
<script>

    var rootDiv = document.getElementById("msa-div")

    var opts = {
    el: rootDiv,
        importURL: "../static/{{ seed_msa_filepath }}",  menu: {
        menuFontsize: "14px",
        menuItemFontsize: "14px",
        menuItemLineHeight: "14px",
        menuMarginLeft: "3px",
        menuPadding: "3px 4px 3px 4px",
    },
    bootstrapMenu: true,
    vis: {
        seqlogo: false,
        conserv: false,
        overviewbox: false,
        gapHeader: false,

        labelId: true,
        labelName: true,
        labelPartition: false,
        labelCheckbox: false
    },
    colorscheme: {
        scheme: "clustal2", // name of your color scheme
        colorBackground: true, // otherwise only the text will be colored
        showLowerCase: true, // used to hide and show lowercase chars in the overviewbox
        opacity: 0.6 //opacity for the residues
    }
    };
    var m = new msa.msa(opts);
    m.render();
</script>

{% comment %} Datatables {% endcomment %}
<script>
    $(document).ready( function () {
        if ($('#pfams-table:contains("No Pfam hits found")').length === 0) {
            $('#pfams-table').DataTable();
        }
        if ($('#structural-annotations-table:contains("No structural annotations found")').length === 0) {
            $('#structural-annotations-table').DataTable();
        }
    } );
</script>

{% endblock %}
